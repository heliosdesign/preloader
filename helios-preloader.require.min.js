define(["jquery"],function($){var parallel_max=5,parallel_current=0,manifest={},index={},loaded={},events={},complete={},on=function(type,callback){events[type]=events[type]||[],events[type].push(callback)},off=function(type){events[type]=[]},trigger=function(type){if(events[type])for(var args=Array.prototype.slice.call(arguments,1),i=0,l=events[type].length;l>i;i++)"function"==typeof events[type][i]&&events[type][i].apply(this,args)},add=function(set,path,filename){manifest[set]||(manifest[set]=[],index[set]=-1,loaded[set]=0,complete[set]=!1),manifest[set].push({path:path,filename:filename,ready:!1})},start=function(set){console.log('[Preloader] start "%s" -> %O',set,manifest[set]),load(set),trigger("start",manifest)},load=function(set){if(parallel_current++,index[set]++,!(index[set]>=manifest[set].length)){{var file=manifest[set][index[set]];$.get(file.path).done(function(){if(file.ready=!0,file.callback&&(file.callback(),file.callback=void 0),trigger("progress",file.filename),loaded[set]+=1,loaded[set]>=manifest[set].length){if(complete[set])return;return console.log('[Preloader] set "%s" complete %s/%s',set,loaded[set],manifest[set].length),complete[set]=!0,void trigger("complete",set)}parallel_current--,load(set)}).fail(function(){console.warn(file.path+" FAILED"),parallel_current--,load(set)})}parallel_max>parallel_current&&load(set)}},getPath=function(name){for(var i=manifest.length-1;i>=0;i--)if(manifest[i].filename===name)return manifest[i].path},whenReady=function(set,name,callback){if("function"==typeof callback){for(var file,i=manifest[set].length-1;i>=0;i--)if(manifest[set][i].filename===name){file=manifest[set][i];break}if(!file)return void console.warn('Canâ€™t add ready callback, no file named "%s" exists.',name);console.log("whenready : %O",file),file.ready===!0?callback():file.callback=callback}};return{start:start,add:add,getPath:getPath,whenReady:whenReady,on:on,off:off,complete:complete}});